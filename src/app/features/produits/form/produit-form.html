<div class="form-container">
  <mat-card class="form-card">
    <!-- En-tête -->
    <div class="header">
      <button mat-icon-button (click)="cancel()" class="back-button">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="title-section">
        <h1>
          <mat-icon>{{ isEditMode ? 'edit' : 'add' }}</mat-icon>
          {{ isEditMode ? 'Modifier le Produit' : 'Nouveau Produit' }}
        </h1>
        <p class="subtitle">
          {{ isEditMode ? 'Modifiez les informations du produit' : 'Remplissez les informations du nouveau produit' }}
        </p>
      </div>
    </div>

    <!-- Formulaire -->
    <form [formGroup]="produitForm" (ngSubmit)="onSubmit()" class="form-content">
      <!-- Loading spinner -->
      <div *ngIf="loading && isEditMode" class="loading-overlay">
        <mat-spinner diameter="50"></mat-spinner>
      </div>

      <!-- Grille de champs -->
      <div class="form-grid">
        <!-- Référence -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Référence *</mat-label>
          <input matInput formControlName="reference" placeholder="Ex: FIL-COTON-001">
          <mat-icon matPrefix>tag</mat-icon>
          <mat-error *ngIf="produitForm.get('reference')?.hasError('required') && produitForm.get('reference')?.touched">
            {{ getErrorMessage('reference') }}
          </mat-error>
          <mat-error *ngIf="produitForm.get('reference')?.hasError('minlength') && produitForm.get('reference')?.touched">
            {{ getErrorMessage('reference') }}
          </mat-error>
        </mat-form-field>

        <!-- Nom -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Nom *</mat-label>
          <input matInput formControlName="name" placeholder="Ex: Bobine fil coton blanc">
          <mat-icon matPrefix>inventory_2</mat-icon>
          <mat-error *ngIf="produitForm.get('name')?.hasError('required') && produitForm.get('name')?.touched">
            {{ getErrorMessage('name') }}
          </mat-error>
          <mat-error *ngIf="produitForm.get('name')?.hasError('minlength') && produitForm.get('name')?.touched">
            {{ getErrorMessage('name') }}
          </mat-error>
        </mat-form-field>

        <!-- Description -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Description *</mat-label>
          <textarea matInput formControlName="description" rows="3" placeholder="Ex: Bobine de fil 100% coton, 1000m"></textarea>
          <mat-icon matPrefix>description</mat-icon>
          <mat-error *ngIf="produitForm.get('description')?.hasError('required') && produitForm.get('description')?.touched">
            {{ getErrorMessage('description') }}
          </mat-error>
          <mat-error *ngIf="produitForm.get('description')?.hasError('minlength') && produitForm.get('description')?.touched">
            {{ getErrorMessage('description') }}
          </mat-error>
        </mat-form-field>

        <!-- Prix Unitaire -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Prix Unitaire (MAD) *</mat-label>
          <input matInput type="number" formControlName="unitPrice" placeholder="Ex: 45.50" step="0.01">
          <mat-icon matPrefix>attach_money</mat-icon>
          <mat-error *ngIf="produitForm.get('unitPrice')?.hasError('required') && produitForm.get('unitPrice')?.touched">
            {{ getErrorMessage('unitPrice') }}
          </mat-error>
          <mat-error *ngIf="produitForm.get('unitPrice')?.hasError('min') && produitForm.get('unitPrice')?.touched">
            {{ getErrorMessage('unitPrice') }}
          </mat-error>
        </mat-form-field>

        <!-- Catégorie -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Catégorie *</mat-label>
          <mat-select formControlName="category">
            <mat-option *ngFor="let option of categoryOptions" [value]="option.value">
              {{ option.label }}
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>category</mat-icon>
          <mat-error *ngIf="produitForm.get('category')?.hasError('required') && produitForm.get('category')?.touched">
            {{ getErrorMessage('category') }}
          </mat-error>
        </mat-form-field>

        <!-- Point de Commande -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Point de Commande *</mat-label>
          <input matInput type="number" formControlName="reorderPoint" placeholder="Ex: 20.0" step="0.1">
          <mat-icon matPrefix>warning</mat-icon>
          <mat-hint>Seuil d'alerte pour la réapprovisionnement</mat-hint>
          <mat-error *ngIf="produitForm.get('reorderPoint')?.hasError('required') && produitForm.get('reorderPoint')?.touched">
            {{ getErrorMessage('reorderPoint') }}
          </mat-error>
          <mat-error *ngIf="produitForm.get('reorderPoint')?.hasError('min') && produitForm.get('reorderPoint')?.touched">
            {{ getErrorMessage('reorderPoint') }}
          </mat-error>
        </mat-form-field>

        <!-- Unité de Mesure -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Unité de Mesure *</mat-label>
          <mat-select formControlName="unitOfMeasure">
            <mat-option *ngFor="let option of unitOptions" [value]="option.value">
              {{ option.label }}
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>straighten</mat-icon>
          <mat-error *ngIf="produitForm.get('unitOfMeasure')?.hasError('required') && produitForm.get('unitOfMeasure')?.touched">
            {{ getErrorMessage('unitOfMeasure') }}
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Boutons d'action -->
      <div class="form-actions">
        <button mat-button type="button" (click)="cancel()" class="cancel-button">
          <mat-icon>close</mat-icon>
          Annuler
        </button>
        <button
          mat-raised-button
          type="submit"
          color="primary"
          [disabled]="produitForm.invalid || loading"
          class="submit-button"
        >
          <mat-spinner *ngIf="loading" diameter="20" class="button-spinner"></mat-spinner>
          <mat-icon *ngIf="!loading">{{ isEditMode ? 'save' : 'add' }}</mat-icon>
          {{ isEditMode ? 'Enregistrer les modifications' : 'Créer le produit' }}
        </button>
      </div>
    </form>
  </mat-card>
</div>
